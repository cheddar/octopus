# This file should be run with 'source' (also known as '.' on linux/macs).
#
# It allows the user to login and then query data via the octopus query endpoint

DEFAULT_ENV="https://devel-api.tidepool.io"

# Login to the tidepool-platfrom and get a session-token
tp_login() {

    if [ -z "$1" ]; then
        echo "your user name is required i.e. tp_login <username>"
        return
    fi

    curl -s -X POST --dump-header headers -u $1 $DEFAULT_ENV/auth/login

    # are you logged in?
    loggedIn="$(grep "200 OK" headers)"
    if [ -z "$loggedIn" ]; then
        echo ""
        echo "something went wrong trying to login. Did you do tp_login <username>?"
        return
    fi
    echo ""
    echo "Your now logged in"
}

# Logout by clearing the token we are storing
tp_logout() {
    rm -rf headers
    echo ""
    echo "You have now logged out"
}

# Run the data query for a given user id
tp_query() {

    # are you logged in?
    loggedIn="$(grep x-tidepool-session-token: headers)"
    if [ -z "$loggedIn" ]; then
        echo "please login first i.e. tp_login <username>"
        return
    fi

    # do we have a user id for us to query?
    if [ -z "$1" ]; then
        echo "we need the id of the user whose data you are querying i.e. tp_query <userid>"
        return
    fi

    # do you want to specify different types to query for?
    QUERY_TYPES="cbg, smbg, bolus, wizard"

    if [ -n "$2" ]; then
        QUERY_TYPES=$2
    fi

    # do you want to constrain the query by time?
    QUERY_WHERE=""

    if [ -n "$3" ]; then
        # e.g. "WHERE time > 2014-11-24T05:00:00.000Z AND time < 2014-12-24T05:00:00.000Z"
        QUERY_WHERE=$3
    fi

    QUERY="METAQUERY WHERE userid IS $1 QUERY TYPE IN $QUERY_TYPES $QUERY_WHERE SORT BY time AS Timestamp REVERSED"

    echo "[$QUERY]"
    echo ""
    read  -p "enter to run the query or [c] to cancel " input

    if [ "$input" = "c" ]; then
        echo ""
        echo "canceled: [$QUERY]"
    else
        curl -X POST -d "$QUERY" $DEFAULT_ENV/query/data
    fi
}